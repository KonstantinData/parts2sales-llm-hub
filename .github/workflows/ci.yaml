name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04

    steps:
      - name: âœ¨ Checkout code
        uses: actions/checkout@v4

      - name: âš™ Install Rye (CI safe mode)
        env:
          CI: "1"
        run: |
          mkdir -p $HOME/.rye
          curl -fsSL https://github.com/astral-sh/rye/releases/latest/download/rye-x86_64-unknown-linux-gnu -o $HOME/.rye/rye
          chmod +x $HOME/.rye/rye
          ln -sf $HOME/.rye/rye $HOME/.rye/shims/rye
          echo "$HOME/.rye/shims" >> $GITHUB_PATH
          echo "$HOME/.rye/bin" >> $GITHUB_PATH
          $HOME/.rye/shims/rye config --set-bool behavior.use-uv=true

      - name: ğŸš€ Install dependencies
        run: ~/.rye/shims/rye sync

      - name: ğŸ”§ Lint code (optional, enable if using ruff/black)
        run: |
          echo "No linter configured yet"
          # ~/.rye/shims/rye run ruff .
          # ~/.rye/shims/rye run black --check .

      - name: âœ… Run tests
        run: ~/.rye/shims/rye run pytest tests/

      - name: ğŸ“Š Upload test results (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/workflow/

  docker-deploy:
    needs: build-and-test
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ğŸ“ƒ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_ROLE_NAME }}
          aws-region: us-east-1

      - name: ğŸš€ Build, tag, and push Docker image to ECR
        env:
          ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}
        run: |
          COMMIT_TAG=$(echo ${GITHUB_SHA::7})
          docker build -t $ECR_REPOSITORY:$COMMIT_TAG .
          docker tag $ECR_REPOSITORY:$COMMIT_TAG $ECR_REPOSITORY:latest
          docker push $ECR_REPOSITORY:$COMMIT_TAG
          docker push $ECR_REPOSITORY:latest
