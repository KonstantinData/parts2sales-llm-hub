name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  build-and-test:
    runs-on: ubuntu-22.04

    steps:
      - name: ✨ Checkout code
        uses: actions/checkout@v4

      - name: ⚙ Install Rye
        run: |
          curl -sSf https://rye.astral.sh/get | bash -s -- --yes
          echo "$HOME/.rye/shims" >> $GITHUB_PATH

      - name: 🚀 Install dependencies
        run: |
          export PATH="$HOME/.rye/shims:$PATH"
          rye sync

      - name: 🔧 Lint code (optional, enable if using ruff/black)
        run: |
          echo "No linter configured yet"
          # rye run ruff .
          # rye run black --check .

      - name: ✅ Run tests
        run: |
          export PATH="$HOME/.rye/shims:$PATH"
          rye run pytest tests/

      - name: 📊 Upload test results (optional)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: tests/workflow/

  docker-deploy:
    needs: build-and-test
    runs-on: ubuntu-22.04
    if: github.ref == 'refs/heads/main'

    steps:
      - name: 📃 Checkout code
        uses: actions/checkout@v4

      - name: 🔐 Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: arn:aws:iam::<DEINE_ACCOUNT_ID>:role/<DEINE_ROLLENNAME>
          aws-region: us-east-1

      - name: 🚀 Build, tag, and push Docker image to ECR
        env:
          ECR_REPOSITORY: <DEIN_ECR_REPOSITORY>
        run: |
          COMMIT_TAG=$(echo ${GITHUB_SHA::7})
          docker build -t $ECR_REPOSITORY:$COMMIT_TAG .
          docker tag $ECR_REPOSITORY:$COMMIT_TAG $ECR_REPOSITORY:latest
          docker push $ECR_REPOSITORY:$COMMIT_TAG
          docker push $ECR_REPOSITORY:latest